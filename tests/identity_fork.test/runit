#!/usr/bin/env bash
bash -n "$0" || exit 1

set -e
source ${TESTSROOTDIR}/tools/runit_common.sh

dbnm=$1

if [ "x$dbnm" == "x" ] ; then
    failexit "need a DB name"
fi

if [[ -z "$CLUSTER" ]]; then
echo 'comdb2_config:default_type=local' > $CDB2_CONFIG
fi

echo '
comdb2_config:allow_pmux_route=false
' >> $CDB2_CONFIG

echo $CDB2_CONFIG > ${TESTDIR}/identity_fork_config

${TESTSBUILDDIR}/identity_fork $dbnm default > ${TESTDIR}/identity_fork_output 2>&1

# Test passes if we don't see the "Identity deleted while being accessed" error
var="$(grep "Identity deleted while being accessed" ${TESTDIR}/identity_fork_output | wc -l)"

if [ "$var" -ne "0" ] ; then
    failexit "Found 'Identity deleted while being accessed' error"
fi

echo "Passed"
