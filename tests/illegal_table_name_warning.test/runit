#!/usr/bin/env bash

source ${TESTSROOTDIR}/tools/cluster_utils.sh
set -ex

test_illegal_table_name_warning() {
	# Given - database has an illegal table name
	local -r illegal_table_name="#illegal_table"
	cdb2sql ${CDB2_OPTIONS} ${DBNAME} default "create table '${illegal_table_name}'(i int)"
	cdb2sql ${CDB2_OPTIONS} ${DBNAME} default "exec procedure sys.cmd.send('flush')"

	# When - database starts up
	set +ex
	kill_restart_node $(hostname)
	set -ex
	
	# Then - database emits warning
	if ! grep "TABLE NAME IS ILLEGAL: '${illegal_table_name}'" $TESTDIR/logs/${DBNAME}.db; then
		echo "FAIL: Database did not emit expected warning"
		return 1
	fi
}

test_illegal_table_name_warning
