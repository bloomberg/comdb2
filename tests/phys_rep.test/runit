#!/usr/bin/env bash

env
dbname=$1
NRECS=10
NRUNS=100

set -x

destdb=${TESTCASE}dest${TESTID}
DEST_DBDIR=${DBDIR}/$destdb
mkdir -p $DEST_DBDIR

# use copycomdb2 to create a physical replicant

$COPYCOMDB2_EXE -H ${destdb} -y localhost ${DBDIR}/$dbname.lrl $DEST_DBDIR

if [ ! $? -eq 0 ]; then
    echo "copycomdb2 failed"
    exit 1
fi

df $DBDIR | awk '{print $1 }' | grep "tmpfs\|nfs" && echo "setattr directio 0" >> $DEST_DBDIR/${destdb}.lrl

if [ -n "$PMUXPORT" ] ; then
    echo "portmux_port $PMUXPORT" >> $DEST_DBDIR/${destdb}.lrl
    echo "portmux_bind_path $pmux_socket" >> $DEST_DBDIR/${destdb}.lrl
fi
$COMDB2_EXE $destdb -lrl $DEST_DBDIR/${destdb}.lrl -pidfile $DEST_DBDIR/${destdb}.pid &

out=
while [[ "$out" != "1" ]]; do
    out=$(CDB2SQL_EXE --tabs ${CDB2_OPTIONS} $destdb local 'select 1' 2>/dev/null)
    sleep 1
done

# requires $1 and $2
equal_queries() {
    lhs="$1" 
    rhs="$2"

    [ "$lhs" = "$rhs" ]
}

cleanup() {
    kill -9 $(cat $DEST_DBDIR/${destdb}.pid)
}

# generate our tests that we will use
set +x
source ./generate_tests
set -x

# iterate over each test
for file in `ls *.src.sql *.sh | sort -V`; do
    # for each sql test execute it
    if [ ${file: -3} == "sql" ]; then
        $(CDB2SQL_EXE -s --tabs -f $file ${CDB2_OPTIONS} $dbname default 2>&1 > /dev/null) 
        query_cmd=$(echo $file | sed 's/\.src\.sql//').query.sql

    else
        source ./"$file"

        query_cmd=$(echo $file | sed 's/\.sh//').query.sql
    fi

    src=$(CDB2SQL_EXE -s --tabs -f $query_cmd ${CDB2_OPTIONS} $dbname default 2>&1 | md5sum) 
    dest=$(CDB2SQL_EXE -s --tabs -f $query_cmd ${CDB2_OPTIONS} $destdb local 2>&1 | md5sum)
    failed=1
    for i in `seq 1 5`;
    do
        if ! $(equal_queries "$src" "$dest"); then
            echo 'Replicant not updated'
            sleep 1
            src=$(CDB2SQL_EXE -s --tabs -f $query_cmd ${CDB2_OPTIONS} $dbname default 2>&1 | md5sum) 
            dest=$(CDB2SQL_EXE -s --tabs -f $query_cmd ${CDB2_OPTIONS} $destdb local 2>&1 | md5sum)
            continue
        fi
        
        failed=0
        break
    done

    if ! [ $failed -eq 0 ]; then
        echo "Failed on $file test."
        $(cleanup)
        exit 1
    fi
done


# echo "Testing truncate table"
# CDB2SQL_EXE ${CDB2_OPTIONS} $dbname default "truncate t1"
# # run the replication step
# ${TESTSBUILDDIR}/localrep $dbname $destdb 2>&1
# src2=$(CDB2SQL_EXE ${CDB2_OPTIONS} $dbname default "select * from t1" | sort | md5sum)
# dest2=$(CDB2SQL_EXE ${CDB2_OPTIONS} $destdb local "select * from t1" | sort | md5sum)
# echo "src2 $src2 dest2 $dest2"

# cleanup
# kill -9 $(cat $DBDIR/${destdb}.pid)
# echo deregister from pmux ${destdb}
# ${TESTSROOTDIR}/tools/send_msg_port.sh "del comdb2/replication/${destdb} " ${pmux_port}

$(cleanup)

exit 0
