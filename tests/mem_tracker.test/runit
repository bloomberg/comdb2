#!/bin/sh

bash -n "$0" | exit 1
set -e

dbnm=$1
host=`cdb2sql ${CDB2_OPTIONS} -s --tabs $dbnm default 'SELECT comdb2_host()'`

# Get the base address of comdb2 binary in the address space of the db process
dbpid=`pgrep -a comdb2 | grep $dbnm | awk '{print $1}'`
baseaddr=`pmap $dbpid | grep comdb2$ | head -1 | awk '{printf "0x%s", $1}'`

cat << EOF | cdb2sql ${CDB2_OPTIONS} -s --tabs $dbnm --host $host - >/dev/null
EXEC PROCEDURE sys.cmd.send("memstat debug on sqlite")
EXEC PROCEDURE sys.cmd.send("memstat debug start")
EOF


cdb2sql ${CDB2_OPTIONS} -s --tabs $dbnm --host $host 'SELECT sleep(5)' &
sleep 1
stacks=`cdb2sql ${CDB2_OPTIONS} -s --tabs $dbnm --host $host 'EXEC PROCEDURE sys.cmd.send("memstat debug dump sqlite 1")'`
# Subtract the base address from virtual address
nooffset=$(for n in `echo "$stacks"|awk '{for(i=1; i<=NF; ++i) {print $i}}'`; do echo $n>&2;printf "0x%x " $(($n-$baseaddr)); done)

addr2line -fsp -e $COMDB2_EXE $nooffset | grep malloc.c

wait

stacks=`cdb2sql ${CDB2_OPTIONS} -s --tabs $dbnm --host $host 'EXEC PROCEDURE sys.cmd.send("memstat debug dump sqlite 1")'`
# Subtract the base address from virtual address
nooffset=$(for n in `echo "$stacks"|awk '{for(i=1; i<=NF; ++i) {print $i}}'`; do printf "0x%x " $(($n-$baseaddr)); done)
addr2line -fsp -e $COMDB2_EXE $nooffset | grep sql_statement_done
