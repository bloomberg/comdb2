#!/bin/bash

bash -n "$0" | exit 1
source ${TESTSROOTDIR}/tools/runit_common.sh

DBNAME=$1

./t1.sh $DBNAME > t1.out 2>&1
[ $? -eq 0 ] || exit 1
if ! diff -q t1.out t1.exp > /dev/null 2>&1 ; then
    echo "diff:"
    diff t1.out t1.exp | head -10
    failexit "t1.sh output diff from expected"
fi

TESTNAME="sp_perf"
output="$TESTNAME.out"
expected="$TESTNAME.exp"
tier="default"
if [ -f $output ] ; then
    rm -f $output
fi

if [[ "x${DBNAME}" == "x" ]] ; then
    echo "need a DB name"
    exit 1
fi

longoremptystringTest() {


sp=$(cat << 'EOF'
CREATE PROCEDURE foo VERSION 'test' { 
local function main(x, input)
    db:setmaxinstructions(10000000)
    local t = {}
    local s = nil
    if input ~= nil then
        s = input
    else 
        s = string.format("%s%s", string.rep('a,', 999999), 'a')
    end
    if x == 'cstring' then s = db:cast(s, 'cstring') end
    local start = db:now()
    for str in string.gmatch(s, "([^,]+)") do table.insert(t, str) end
    db:column_name("count", 1) db:column_name("time", 2) db:column_name("type", 3)
    db:emit({count = #t, time = db:now() - start, type = type(s)})
end
}
EOF
)
${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "$sp"
time ${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "exec procedure foo()"
time ${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "exec procedure foo('cstring')"
time ${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "exec procedure foo('cstring', 'spookytext')"
time ${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "exec procedure foo('cstring', '')"
}


bindparamTest() {

$CDB2SQL_EXE ${CDB2_OPTIONS} $DBNAME $tier - <<EOF 
drop table if exists bindt
create table bindt { 
schema {
    cstring i[32] null=yes
    cstring j[32] null=yes
}}\$\$
EOF

sp_bind_pos=$(cat << 'EOF'
CREATE PROCEDURE bind_sp VERSION 'test' {
local function main() 
    local t, r
    t = db:prepare("INSERT INTO bindt(i, j) values(?,?)")
    t:bind(1, "1") -- bind by pos
    t:bind(2, "")
    t:exec()
end
}
EOF
)

sp_bind_name=$(cat << 'EOF'
CREATE PROCEDURE bind_sp_named VERSION 'test' {
local function main() 
    local t, r, a, b
    t = db:prepare("INSERT INTO bindt(i, j) values(@a, @b)")
    t:bind("a", "5") -- bind by name
    t:bind("b", "6")
    t:exec()
end
}
EOF
)

${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "$sp_bind_pos"
${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "exec procedure bind_sp()"
${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "SELECT i, j FROM bindt where i='1'"
${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "$sp_bind_name"
${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "exec procedure bind_sp_named()"
${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier "SELECT i, j FROM bindt where i='5'"
${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier - <<EOF
INSERT INTO bindt (i, j) VALUES ('5', NULL)
INSERT INTO bindt (i, j) VALUES ('', '6')
EOF

}

checkdiff() {
if [ -f "$1" ]; then
    if ! diff -w $2 $1 > /dev/null 2>&1 ; then
        echo "diff:"
        diff -w $2 $1
        failexit "output $1 diff from expected $2"
    else
        echo "PASSED!"
    fi
else
    failexit "ERR: No expected output file ($2) found for runit"
fi

}

longoremptystringTest

bindparamTest >> "$output" 2>&1
checkdiff "$output" "$expected"

${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier -f t1.sql > t1.out 2>&1
[ $? -eq 0 ] || exit 1
if ! diff -q t1.out t1.expected > /dev/null 2>&1 ; then
    echo "diff:"
    diff t1.out t1.expected | head -10
    failexit "t1.sql output diff from expected"
fi

${CDB2SQL_EXE} -r 1 ${CDB2_OPTIONS} $DBNAME $tier -f t2.sql >> t2.out 2>&1
if [ $? -ne 0 ] ; then
    failexit "t2.sql failed"
fi
${TESTSBUILDDIR}/sp $DBNAME $tier t update_t '1,"regstr"' ${CDB2_CONFIG} >> t2.out 2>&1
if [ $? -ne 0 ] ; then
    failexit "sp update_t failed"
fi
$CDB2SQL_EXE -r 1 ${CDB2_OPTIONS} $DBNAME $tier "select a from t where id=1" >> t2.out 2>&1
[ $? -eq 0 ] || exit 1
${TESTSBUILDDIR}/sp $DBNAME $tier t update_t '1,""' ${CDB2_CONFIG} >> t2.out 2>&1
if [ $? -ne 0 ] ; then
    failexit "sp update_t failed"
fi
$CDB2SQL_EXE -r 1 ${CDB2_OPTIONS} $DBNAME $tier "select a from t where id=1" >> t2.out 2>&1
[ $? -eq 0 ] || exit 1
${TESTSBUILDDIR}/sp $DBNAME $tier t update_t '1," "' ${CDB2_CONFIG} >> t2.out 2>&1
if [ $? -ne 0 ] ; then
    failexit "sp update_t failed"
fi
$CDB2SQL_EXE -r 1 ${CDB2_OPTIONS} $DBNAME $tier "select a from t where id=1" >> t2.out 2>&1
[ $? -eq 0 ] || exit 1

if ! diff -q t2.out t2.exp > /dev/null 2>&1 ; then
    echo "diff:"
    diff t2.out t2.exp | head -10
    failexit "t2.sql output diff from expected"
fi
echo "Testcase passed."

exit 0


