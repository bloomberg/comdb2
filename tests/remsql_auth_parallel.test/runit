#!/usr/bin/env bash

# Verify required variables
vars="TESTCASE DBNAME DBDIR TESTSROOTDIR TESTDIR CDB2_OPTIONS CDB2_CONFIG SECONDARY_DBNAME SECONDARY_DBDIR SECONDARY_CDB2_CONFIG SECONDARY_CDB2_OPTIONS"
for required in $vars; do
    q=${!required}
    echo "$required=$q"
    if [[ -z "$q" ]]; then
        echo "$required not set" >&2
        exit 1
    fi
done

# Transform query to use actual secondary db name
sed "s/LOCAL_REMOTEDB/LOCAL_$SECONDARY_DBNAME/g" remsql_query.req > remsql_query_run.req

# Insert test data into secondary database
echo "Inserting test data into secondary database..."
cdb2sql ${SECONDARY_CDB2_OPTIONS} $SECONDARY_DBNAME default --cdb2cfg $SECONDARY_CDB2_CONFIG "insert into t values (1, 'one')"
cdb2sql ${SECONDARY_CDB2_OPTIONS} $SECONDARY_DBNAME default --cdb2cfg $SECONDARY_CDB2_CONFIG "insert into t values (2, 'two')"
cdb2sql ${SECONDARY_CDB2_OPTIONS} $SECONDARY_DBNAME default --cdb2cfg $SECONDARY_CDB2_CONFIG "insert into t values (3, 'three')"

# Setup authentication on primary database
echo "Setting up authentication on primary database..."
cdb2sql ${CDB2_OPTIONS} $DBNAME default --cdb2cfg $CDB2_CONFIG "put password 'password1' for 'user1'"
cdb2sql ${CDB2_OPTIONS} $DBNAME default --cdb2cfg $CDB2_CONFIG -f grant_auth.req

echo "Running remote query with authentication..."
cdb2sql ${CDB2_OPTIONS} $DBNAME default --cdb2cfg $CDB2_CONFIG -s -f remsql_query_run.req > output.txt 2>&1

if ! diff output.txt remsql_query.exp ; then
    echo "FAILURE: Output mismatch"
    echo "Expected:"
    cat remsql_query.exp
    echo "Got:"
    cat output.txt
    exit 1
fi

echo "SUCCESS"
