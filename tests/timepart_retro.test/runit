#!/usr/bin/env bash
bash -n "$0" | exit 1
source ${TESTSROOTDIR}/tools/runit_common.sh

# args
# <dbname>
DBN=$1

OUT="run.log"
C="cdb2sql ${CDB2_OPTIONS} ${DBN} default"
CT="cdb2sql --tabs ${CDB2_OPTIONS} ${DBN} default"
master=`getmaster`
CM="cdb2sql ${CDB2_OPTIONS} ${DBN} --host ${master}"

rm $OUT 2>/dev/null
touch $OUT

delayed_writes()
{
    $CM "exec procedure sys.cmd.send('debg 500')"
    $CM "exec procedure sys.cmd.send('ndebg 500')"
    echo "Sleeping 10 seconds"
    sleep 10
    $C "delete from t where a between 1 and 10 or a between 101 and 110"
    echo "Sleeping 10 more seconds"
    sleep 10
    $C "update t set a = a + 1000 where a between 11 and 15 or a between 111 and 115"
    sleep 10
    echo "Sleeping 10 more seconds finally"
    $C "insert into t(a) select * from generate_series(2001, 2010)"
}

echo "Inserting the first set"
echo "Time `${CT} 'select now()'`"
sleep 5
$C "insert into t(a) select * from generate_series(1, 60)" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE inserting first set"
   exit 1
fi

# no race between insert and rollout, want insert in last shard
sleep 5
start=`${CT} "select now() + cast(1 as days)"`
start=`echo ${start} | sed "s/\"/'/g"`
echo "Using $start as the rollout edge"
sleep 5

echo "Inserting the second set"
echo "Time `${CT} 'select now()'`"
$C "insert into t(a) select * from generate_series(101, 160)" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE inserting second set"
   exit 1
fi

echo "Slow down the schema change"
$CM "exec procedure sys.cmd.send('bdb setattr SC_FORCE_DELAY 1')"
if (( $? != 0 )) ; then
   echo "FAILURE to setattr sc_force_delay"
   exit 1
fi
$CM "exec procedure sys.cmd.send('scdelay 1000')"
if (( $? != 0 )) ; then
   echo "FAILURE to scdelay"
   exit 1
fi

echo "Launching delayed writes"
delayed_writes &

echo "Partitioning the table"
$C "ALTER TABLE T PARTITIONED BY TIME PERIOD 'daily' RETENTION 2 START ${start} RETROACTIVELY" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE to partition retroactively"
   exit 1
fi

echo  "Checking the shards"
$C "select shardname from comdb2_timepartshards" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE to get the shards"
   exit 1
fi
$C "select count(*) from t" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE to count total rows"
   exit 1
fi
$C "select count(*) from '\$0_F64CD191'" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE to count first shard rows"
   exit 1
fi
$C "select a from '\$0_F64CD191' order by a" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE to list first shard rows"
   exit 1
fi
$C "select count(*) from '\$1_A2620AE4'" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE to count second shard rows"
   exit 1
fi
$C "select a from '\$1_A2620AE4' order by a" >> $OUT
if (( $? != 0 )) ; then
   echo "FAILURE to list second shard rows"
   exit 1
fi
testcase_output=$(cat $OUT)
expected_output=$(cat output.log)
if [[ "$testcase_output" != "$expected_output" ]]; then

   # print message 
   echo "  ^^^^^^^^^^^^"
   echo "The above testcase (${testcase}) has failed!!!" 
   echo " "
   echo "Use 'diff <expected-output> <my-output>' to see why:"
   echo "> diff ${PWD}/{output.log,run.log}"
   echo " "
   diff output.log $OUT
   echo " "

   # quit
   exit 1
fi

echo "SUCCESS"
