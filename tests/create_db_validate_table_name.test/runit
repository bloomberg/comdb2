#!/usr/bin/env bash
bash -n "$0" | exit 1
source ${TESTSROOTDIR}/tools/runit_common.sh

[[ $debug -eq 1 ]] && set -x

# GIVEN: a table name that is longer than 31 characters.
mkdir -p ${DBDIR}
echo "schema { int id }" >> ${DBDIR}/table.csc2
echo "table t2345678901234567890123456789012 table.csc2" > ${DBDIR}/${DBNAME}.lrl

# WHEN: the database is created.
${COMDB2_EXE} ${DBNAME} --create --dir ${DBDIR} --lrl ${DBDIR}/${DBNAME}.lrl &> out

# THEN: database creation fails.
[[ $? -eq 0 ]] && failexit "expected database creation to fail"
grep "\[FATAL\] Table name is too long" out || failexit "expected database to complain about long table name"

# Cleanup before next test
rm out ${DBDIR}/${DBNAME}.lrl

# GIVEN: a table name that is under the maximum length but contains illegal characters.
echo "table table-with>illegal<chars table.csc2" > ${DBDIR}/${DBNAME}.lrl

# WHEN: the database is created.
${COMDB2_EXE} ${DBNAME} --create --dir ${DBDIR} --lrl ${DBDIR}/${DBNAME}.lrl &> out

# THEN: database creation fails.
[[ $? -eq 0 ]] && failexit "expected database creation to fail"
grep "\[FATAL\] Table name contains illegal characters" out || failexit "expected database to complain about invalid table name"

# Cleanup before next test
rm out ${DBDIR}/${DBNAME}.lrl

# GIVEN: a table name that is under the maximum length and contains all supported special characters.
echo 'table ._$0123456789 table.csc2' > ${DBDIR}/${DBNAME}.lrl

# WHEN: the database is created.
${COMDB2_EXE} ${DBNAME} --create --dir ${DBDIR} --lrl ${DBDIR}/${DBNAME}.lrl &> out

# THEN: database creation succeeds.
[[ $? -ne 0 ]] && failexit "expected database creation to succeed"
grep "Created database" out || failexit "expected database creation to succeed"

# Cleanup before next test
rm out ${DBDIR}/${DBNAME}.lrl

# GIVEN: a table name that is exactly the maximum length of 31 characters.
echo 'table t234567890123456789012345678901 table.csc2' > ${DBDIR}/${DBNAME}.lrl

# WHEN: the database is created.
${COMDB2_EXE} ${DBNAME} --create --dir ${DBDIR} --lrl ${DBDIR}/${DBNAME}.lrl &> out

# THEN: database creation succeeds.
[[ $? -ne 0 ]] && failexit "expected database creation to succeed"
grep "Created database" out || failexit "expected database creation to succeed"

echo "Success"
exit 0
