#!/usr/bin/env bash
bash -n "$0" | exit 1

# Cursor moves testcase for comdb2
################################################################################

TMPDIR=${TMPDIR:-/tmp}

set -e 

# args
a_dbn=$1
r="cdb2sql -s ${CDB2_OPTIONS} $a_dbn default"

echo "Inserting rows"
i=-1
while [ "$i" != "-100" ] ; do
    $r "insert into t values ($i, '123456789')"
    let i=i-1
done
i=0
while [ "$i" != "1000000" ] ; do
    $r "insert into t2 values ($i, '123456789')"
    let i=i+1
done


$r "exec procedure sys.cmd.send('dohsql_max_queued_kb_highwm 2000')"

$r "select a,b from t union all select a,b from t2 order by a"

$r "exec procedure sys.cmd.send('stat dohsql')" > log.out 2>&1



# get testcase output
testcase_output=$(cat log.out)

# get expected output
expected_output=$(cat log.expected)

# verify 
if [[ "$testcase_output" != "$expected_output" ]]; then

        echo "  ^^^^^^^^^^^^"
        echo " FAILED TEST " 
        echo "Use 'diff <expected-output> <my-output>' to see why:"
        echo "> diff ${PWD}/{log.out,log.expected}"
        echo " "
        diff log.out log.expected
        echo " "
        exit 1

    fi

echo "Testcase passed."
