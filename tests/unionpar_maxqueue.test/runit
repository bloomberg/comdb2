#!/usr/bin/env bash
bash -n "$0" | exit 1

TMPDIR=${TMPDIR:-/tmp}

set -e 

# args
a_dbn=$1
r="cdb2sql -s ${CDB2_OPTIONS} $a_dbn default"

echo "Inserting rows"
$r "insert into t select value from generate_series(-99, 0)"

$r << "EOF"
set maxtransize 1000000000
insert into t2 select value from generate_series(1, 1000000)
EOF

$r "alter table t add b cstring(1000) default '          '"
$r "alter table t2 add b cstring(1000) default '          '"

$r "exec procedure sys.cmd.send('dohsql_max_queued_kb_highwm 2000')"

$r "select a,b from t union all select a,b from t2 order by a" | wc -l

$r "exec procedure sys.cmd.send('stat dohsql')"|egrep -v "length" > log.out 2>&1


# get testcase output
testcase_output=$(cat log.out)

# get expected output
expected_output=$(cat log.expected)

# verify 
if [[ "$testcase_output" != "$expected_output" ]]; then

        echo "  ^^^^^^^^^^^^"
        echo " FAILED TEST " 
        echo "Use 'diff <expected-output> <my-output>' to see why:"
        echo "> diff ${PWD}/{log.out,log.expected}"
        echo " "
        diff log.out log.expected
        echo " "
        exit 1

    fi

echo "Testcase passed."

