#!/usr/bin/env bash
bash -n "$0" | exit 1

dbname=$1
if [[ -z $dbname ]] ; then
    echo dbname missing
    exit 1
fi

for testreq in `find . -name 't[0-9][0-9].sql' -exec basename {} \;` ; do
    testname=`echo $testreq | cut -d "." -f 1`
    cmd="cdb2sql -s -f $testreq ${CDB2_OPTIONS} $dbname default "
    echo $cmd "> $testname.output"
    $cmd > $testname.output 2>&1
    cmd="diff $testname.expected $testname.output"
    $cmd > /dev/null

    if [[  $? -eq 0 ]]; then
        echo "passed $testname"
    else
        echo "failed $testname"
        echo "see diffs here: $HOSTNAME"
        echo "> diff -u ${PWD}/{$testname.expected,$testname.output}"
        echo
        exit 1
    fi
done

for testreq in `find . -name 't[0-9][0-9].tab.sql' -exec basename {} \;` ; do
    testname=`echo $testreq | cut -d "." -f 1`
    cmd="cdb2sql -s -f $testreq ${CDB2_OPTIONS} -tabular $dbname default "
    echo $cmd "> $testname.tab.output"
    $cmd > $testname.tab.output 2>&1

    cmd="diff $testname.tab.expected $testname.tab.output"
    $cmd > /dev/null

    if [[  $? -eq 0 ]]; then
        echo "passed $testname"
    else
        echo "failed $testname"
        echo "see diffs here: $HOSTNAME"
        echo "> diff -u ${PWD}/{$testname.tab.expected,$testname.tab.output}"
        echo
        exit 1
    fi
done


testname=delimiter
rm $testname.output
echo "test #1" >> $testname.output
cdb2sql -s -d ";" ${CDB2_OPTIONS} $dbname default "select 1; select 2;" >> $testname.output
echo "test #2" >> $testname.output
cdb2sql -s -d ";" ${CDB2_OPTIONS} $dbname default "drop table if exists t1; create table t1(i int); insert into t1 values(1);" >> $testname.output
echo "test #3" >> $testname.output
cdb2sql -s -d ";" ${CDB2_OPTIONS} $dbname default "begin; select * from t1; insert into t1 values(2); select * from t1; commit; select '-- after commit --'; select * from t1;" >> $testname.output

cmd="diff $testname.expected $testname.output"
$cmd > /dev/null
if [[  $? -eq 0 ]]; then
    echo "passed $testname test"
else
    echo "failed $testname"
    echo "see diffs here: $HOSTNAME"
    echo "> diff -u ${PWD}/{$testname.expected,$testname.output}"
    echo
    exit 1
fi

echo
exit 0
