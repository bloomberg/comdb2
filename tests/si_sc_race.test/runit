#!/usr/bin/env bash
bash -n "$0" | exit 1

dbname=$1

send_to_cluster() {
    local cmd="$1"
    if [ -n "${CLUSTER}" ]; then
        for node in ${CLUSTER}; do
            cdb2sql ${CDB2_OPTIONS} ${dbname} default --host "${node}" "$cmd"
        done
    else
        cdb2sql ${CDB2_OPTIONS} ${dbname} default --host "$(hostname)" "$cmd"
    fi
}

test_select_fails_when_concurrent_sc() {
    # This test demonstrates that a standalone snapshot select can fail if a schema change
    # occurs between caching the table versions and executing the select.
    cdb2sql ${CDB2_OPTIONS} ${dbname} default "create table t(i int)"
    cdb2sql ${CDB2_OPTIONS} ${dbname} default "insert into t values(1)"
    send_to_cluster "exec procedure sys.cmd.send('sleep_5s_after_caching_table_versions on')"
    cdb2sql ${CDB2_OPTIONS} ${dbname} default "select * from t" &
    local -r pid=$!
    sleep 1
    send_to_cluster "exec procedure sys.cmd.send('sleep_5s_after_caching_table_versions off')"
    cdb2sql ${CDB2_OPTIONS} ${dbname} default "alter table t add column j int"
    if wait ${pid}; then
        echo "FAIL: expected select to fail, but it succeeded"
        return 1
    fi
}

test_select_fails_when_concurrent_sc
