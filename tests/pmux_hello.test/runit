#!/bin/bash

debug=1
[[ "$debug" == 1 ]] && set -x

db=$1
COMDB2_PMUX_PORT=19500
COMDB2_PMUX_FILE=./pmux.sqlite

if [[ -z "$stage" ]]; then
    echo "Setting stage to 'default' (set 'stage' var to override)."
    stage="default"
fi

function empty_used_list_crash
{
    [[ "$debug" == 1 ]] && echo "STARTING ${FUNCNAME[0]}" && set -x
    ${TESTSROOTDIR}/../pmux -n -f -p ${COMDB2_PMUX_PORT} -b /tmp/pmux.${COMDB2_PMUX_PORT} &
    pid=$!
    sleep 5
    echo "del pmux" | nc -w 1 localhost ${COMDB2_PMUX_PORT}
    echo "used" | nc -w 1 localhost ${COMDB2_PMUX_PORT}
    sleep 1
    kill -0 $pid
    if [[ $? != 0 ]]; then
        echo "${FUNCNAME[0]} test failed: empty used list killed pmux"
        exit 1
    fi
}

function verify_hello_reuse
{
    [[ "$debug" == 1 ]] && echo "STARTING ${FUNCNAME[0]}" && set -x
    iters=20
    start_timeout=30

    # Create a db
    DBDIR=$(pwd)/$db
    ${TESTSROOTDIR}/../comdb2 $db --create --dir $DBDIR

    # Modify our config file
    echo "comdb2_config:portmuxport=$COMDB2_PMUX_PORT" >> $CDB2_CONFIG
    echo "comdb2_config:allow_pmux_route:true" >> $CDB2_CONFIG

    # Tweak lrl
    DBLRL=$DBDIR/${db}.lrl
    echo "portmux_port ${COMDB2_PMUX_PORT}" >> $DBLRL
    echo "portmux_bind_path /tmp/pmux.${COMDB2_PMUX_PORT} " >> $DBLRL

    # Start the test
    i=0
    while [[ $i -lt $iters ]]; do
        ${TESTSROOTDIR}/../comdb2 ${db} --lrl $DBLRL &
        dbpid=$!

        let i=i+1

        t=0
        while [[ $t -lt $start_timeout ]]; do
        done
    done

}

function runtest
{
    [[ "$debug" == 1 ]] && echo "STARTING ${FUNCNAME[0]}" && set -x
    empty_used_list_crash
    verify_hello_reuse
}

runtest

echo "Success"
exit 0
