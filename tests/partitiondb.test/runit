#!/usr/bin/env bash
bash -n "$0" | exit 1
set -x

SHARDS_LIST="$DBNAME $SECONDARY_DBNAME"

# for pdb discovery to work for this test, we need to add the cluster lines from the extra dbs into the primary db comdb2 config
# since SECONDARY_CDB2_OPTIONS will not be used when querying partitiondb
cluster_line=$(head -n 1 $DBDIR/comdb2db.cfg)
echo "s1$cluster_line" >> $DBDIR/comdb2db.cfg

echo "partition partitiondb:$SHARDS_LIST" >> $DBDIR/comdb2db.cfg

P_SQL="cdb2sql --tabs ${CDB2_OPTIONS} partitiondb default"

shard=$($P_SQL "select comdb2_dbname()")
if [[ $shard != $DBNAME && $shard != $SECONDARY_DBNAME ]]; then
	echo "Got dbname $shard but expected one in ($DBNAME, $SECONDARY_DBNAME)"
	exit 1
fi;

echo "Success"
