1 CREATE TABLE t1(i INT PRIMARY KEY, j INT)
1 SET TRANSACTION READ COMMITTED
2 SET TRANSACTION READ COMMITTED
1 BEGIN
2 BEGIN
1 INSERT INTO t1 VALUES(1, 0) ON CONFLICT DO NOTHING;
1 SELECT * FROM t1;
2 INSERT INTO t1 VALUES(1, 1);
2 SELECT * FROM t1;
2 COMMIT
1 COMMIT
1 SELECT * FROM t1;
1 DROP TABLE t1;

1 CREATE TABLE t1(i INT PRIMARY KEY, j INT)
1 SET TRANSACTION READ COMMITTED
2 SET TRANSACTION READ COMMITTED
1 BEGIN
2 BEGIN
1 INSERT INTO t1 VALUES(1, 0) ON CONFLICT DO REPLACE;
1 SELECT * FROM t1;
2 INSERT INTO t1 VALUES(1, 1);
2 SELECT * FROM t1;
2 COMMIT
1 COMMIT
1 SELECT * FROM t1;
1 DROP TABLE t1;

1 CREATE TABLE t1(i INT PRIMARY KEY, j INT)
1 SET TRANSACTION READ COMMITTED
2 SET TRANSACTION READ COMMITTED
1 BEGIN
2 BEGIN
1 INSERT INTO t1 VALUES(1, 0) ON CONFLICT(i) DO UPDATE SET j = j + 1;
1 SELECT * FROM t1;
2 INSERT INTO t1 VALUES(1, 1);
2 SELECT * FROM t1;
2 COMMIT
1 COMMIT
1 SELECT * FROM t1;
1 DROP TABLE t1;

# Test upsert1-400 from upstream
# BLOCKSQL Isolation level
1 SET TRANSACTION BLOCKSQL
1 CREATE TABLE t1(a VARCHAR(10) UNIQUE, b INT DEFAULT 1)
1 INSERT INTO t1(a) VALUES('one'),('two'),('three');
1 BEGIN
1 INSERT INTO t1(a) VALUES('one'),('one'),('three'),('four') ON CONFLICT(a) DO UPDATE SET b=b+1;
1 SELECT * FROM t1;
1 COMMIT
1 SELECT * FROM t1;
# READ COMMITTED Isolation level
1 SET TRANSACTION READ COMMITTED
1 BEGIN
1 INSERT INTO t1(a) VALUES('one'),('one'),('three'),('four') ON CONFLICT(a) DO UPDATE SET b=b+1;
1 SELECT * FROM t1;
1 COMMIT
1 SELECT * FROM t1;

# Test upsert1-400 from upstream
1 SELECT a, b FROM t1 ORDER BY a;
1 DROP TABLE t1;

# Test upsert2-200 from upstream
# BLOCKSQL Isolation level
1 SET TRANSACTION BLOCKSQL
1 CREATE TABLE t1(a INTEGER PRIMARY KEY, b INT, c INT DEFAULT 0)
1 INSERT INTO t1(a,b) VALUES(1,2),(3,4);
1 BEGIN
1 WITH nx(a,b) AS (VALUES(1,8),(2,11),(3,1),(2,15),(1,4),(1,99)) INSERT INTO t1(a,b) SELECT a, b FROM nx WHERE 1 ON CONFLICT(a) DO UPDATE SET b=excluded.b, c=c+1 WHERE t1.b<excluded.b;
1 SELECT *, 'x' FROM t1 ORDER BY a;
1 COMMIT
1 SELECT *, 'x' FROM t1 ORDER BY a;
# READ COMMITTED Isolation level
1 SET TRANSACTION READ COMMITTED
1 BEGIN
1 WITH nx(a,b) AS (VALUES(1,8),(2,11),(3,1),(2,15),(1,4),(1,99)) INSERT INTO t1(a,b) SELECT a, b FROM nx WHERE 1 ON CONFLICT(a) DO UPDATE SET b=excluded.b, c=c+1 WHERE t1.b<excluded.b;
1 SELECT *, 'x' FROM t1 ORDER BY a;
1 COMMIT
1 SELECT *, 'x' FROM t1 ORDER BY a;
1 DROP TABLE t1;
1 SET TRANSACTION BLOCKSQL
