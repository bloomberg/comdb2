#!/usr/bin/env bash
bash -n "$0" | exit 1
source ${TESTSROOTDIR}/tools/runit_common.sh
   
[[ $debug -eq 1 ]] && set -x

dbname=$1
if [[ -z "$dbname" ]]; then
    echo "dbname missing"
    exit 1
fi

for testreq in `ls t*.req`; do
    testname=`echo ${testreq} | cut -d "." -f 1`
    cdb2sql -f "${testreq}" ${CDB2_OPTIONS} "${dbname}" default > "${testname}.output" 2>&1

    testcase_output=$(cat "${testname}.output")
    expected_output=$(cat "${testname}.expected")

    if [[ "${testcase_output}" != "${expected_output}" ]]; then
        echo "The testcase '${testname}' has failed."
        echo " "
        echo "Use 'diff <expected-output> <actual-output>' to see why:"
        echo "> diff ${PWD}/{$testname.expected,$testname.output}"
        echo " "
        diff $testname.expected $testname.output
        echo " "
        exit 1
    fi
done

echo "Success"
exit 0
