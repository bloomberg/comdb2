#!/bin/bash 

TMPDIR=${TMPDIR:-/tmp}
dbname=$1

echo db is $dbname 
echo options $CDB2_OPTIONS

(
cdb2sql ${CDB2_OPTIONS} ${dbname} default - <<'EOF'
drop table if exists t;
drop table if exists q;

begin
create table t {
schema {
    int a
}

keys {
    "a" = a
}

constraints {
    "a" -> "q":"a" on delete cascade
}
} $$

create table q {
schema {
    int a
}

keys {
    "a" = a
}
} $$
commit
EOF

echo insert into t fails
cdb2sql ${CDB2_OPTIONS} ${dbname} "insert into t values(1)" ## fails
echo insert into q
cdb2sql ${CDB2_OPTIONS} ${dbname} "insert into q values(1)"
echo insert into t now succeeds
cdb2sql ${CDB2_OPTIONS} ${dbname} "insert into t values(1)" ## now succeeds
echo "select * from t"
cdb2sql ${CDB2_OPTIONS} ${dbname} "select * from t"         ## 1 
echo "select * from t"
cdb2sql ${CDB2_OPTIONS} ${dbname} "select * from q"         ## 1 
echo "delete from q"
cdb2sql ${CDB2_OPTIONS} ${dbname} "delete from q where 1"
echo "select * from t"
cdb2sql ${CDB2_OPTIONS} ${dbname} "select * from t"         ## empty 
echo "select * from q"
cdb2sql ${CDB2_OPTIONS} ${dbname} "select * from q"         ## empty?
) > out 2>&1 
exit 0
