#!/usr/bin/env bash
bash -n "$0" | exit 1

##############################
# Test SSL session cache TTL #
##############################

dbnm=$1

# set up users for charlie and sally brown
cat << EOF | cdb2sql ${CDB2_OPTIONS} $dbnm default -
put password 'brown' for 'charlie'
put password 'brown' for 'sally'
grant op to charlie
grant op to sally
select * from comdb2_users
set user charlie
set password brown
put authentication on
EOF

# gen keys for charlie brown
openssl genrsa -out ${TESTDIR}/charlie.key 4096
openssl req -new -key ${TESTDIR}/charlie.key -out ${TESTDIR}/charlie.key.csr \
            -subj "/C=US/ST=New York/L=New York/O=Bloomberg/OU=Comdb2/CN=*.bloomberg.com/UID=charlie"
openssl x509 -req -in ${TESTDIR}/charlie.key.csr -CA ${TESTDIR}/root.crt -CAkey ${TESTDIR}/root.key \
             -CAcreateserial -out ${TESTDIR}/charlie.crt -days 10
chmod 600 ${TESTDIR}/charlie.key

# set up charlie's data
cat << EOF | cdb2sql ${CDB2_OPTIONS} $dbnm default -
SET SSL_CERT ${TESTDIR}/charlie.crt
SET SSL_KEY ${TESTDIR}/charlie.key
CREATE TABLE whoami (name CHAR(30))\$\$
INSERT INTO whoami values ("Charlie Brown")
EOF

# gen keys for sally brown
openssl genrsa -out ${TESTDIR}/sally.key 4096
openssl req -new -key ${TESTDIR}/sally.key -out ${TESTDIR}/sally.key.csr \
            -subj "/C=US/ST=New York/L=New York/O=Bloomberg/OU=Comdb2/CN=*.bloomberg.com/UID=sally"
openssl x509 -req -in ${TESTDIR}/sally.key.csr -CA ${TESTDIR}/root.crt -CAkey ${TESTDIR}/root.key \
             -CAcreateserial -out ${TESTDIR}/sally.crt -days 10
chmod 600 ${TESTDIR}/sally.key

# set up sally's data
cat << EOF | cdb2sql ${CDB2_OPTIONS} $dbnm default -
SET SSL_CERT ${TESTDIR}/sally.crt
SET SSL_KEY ${TESTDIR}/sally.key
CREATE TABLE whoami (name CHAR(30))\$\$
INSERT INTO whoami values ("Sally Brown")
EOF

# generate a config file for the browns
cp $DBDIR/comdb2db.cfg $DBDIR/browns.cfg
echo "comdb2_config:ssl_cert=$TESTDIR/brown.crt
comdb2_config:ssl_key=$TESTDIR/brown.key
comdb2_config:ssl_session_cache_ttl=5" >>$DBDIR/browns.cfg

# This is the main body of the test:
# We first point the certificate to charlie, and issue a read. We should see charlie's
# data. We then point the certificate to sally, sleep 6 seconds to let charlie's
# session age out, and issue another read. We should see sally's data at this point.
cp $TESTDIR/charlie.key $TESTDIR/brown.key
cp $TESTDIR/charlie.crt $TESTDIR/brown.crt

cdb2sql --cdb2cfg $DBDIR/browns.cfg -f sql -s --tabs $dbnm default - >output.actual 2>&1 &

sleep 2
cp $TESTDIR/sally.key $TESTDIR/brown.key
cp $TESTDIR/sally.crt $TESTDIR/brown.crt

wait
diff output.actual output.expected
