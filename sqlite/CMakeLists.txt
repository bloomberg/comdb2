add_library(sqlite
  ext/comdb2/appsock_handlers.c
  ext/comdb2/columns.c
  ext/comdb2/constraints.c
  ext/comdb2/keycomponents.c
  ext/comdb2/keys.c
  ext/comdb2/keywords.c
  ext/comdb2/limits.c
  ext/comdb2/opcode_handlers.c
  ext/comdb2/plugins.c
  ext/comdb2/procedures.c
  ext/comdb2/tablepermissions.c
  ext/comdb2/tables.c
  ext/comdb2/timepartitions.c
  ext/comdb2/tablesizes.c
  ext/comdb2/threadpools.c
  ext/comdb2/triggers.c
  ext/comdb2/tunables.c
  ext/comdb2/users.c
  ext/comdb2/clientstats.c
  ext/comdb2/ezsystables.c
  ext/comdb2/typesamples.c 
  ext/misc/completion.c
  ext/misc/json1.c
  ext/expert/sqlite3expert.c
  ext/misc/series.c
  src/analyze.c
  src/attach.c
  src/auth.c
  src/bitvec.c
  src/btmutex.c
  src/build.c
  src/callback.c
  src/comdb2build.c
  src/comdb2lua.c
  src/comdb2vdbe.c
  src/complete.c
  src/ctime.c
  src/dbstat.c
  src/decimal.c
  src/delete.c
  src/dttz.c
  src/expr.c
  src/fault.c
  src/func.c
  src/global.c
  src/hash.c
  src/insert.c
  src/keywordhash.h
  src/legacy.c
  src/loadext.c
  src/main.c
  src/malloc.c
  src/md5.c
  src/mem1.c
  src/memcompare.c
  src/memjournal.c
  src/mutex.c
  src/mutex_noop.c
  src/mutex_unix.c
  src/opcodes.c
  src/os.c
  src/os_unix.c
  src/parse.c
  src/pragma.c
  src/prepare.c
  src/printf.c
  src/random.c
  src/resolve.c
  src/rowset.c
  src/select.c
  src/serialget.c
  src/sqlite_tunables.c
  src/status.c
  src/table.c
  src/tokenize.c
  src/treeview.c
  src/trigger.c
  src/update.c
  src/utf.c
  src/util.c
  src/vdbe.c
  src/vdbeapi.c
  src/vdbeaux.c
  src/vdbeblob.c
  src/vdbecompare.c
  src/vdbemem.c
  src/vdbesort.c
  src/vdbetrace.c
  src/vtab.c
  src/walker.c
  src/where.c
  src/wherecode.c
  src/whereexpr.c
)
include(${PROJECT_SOURCE_DIR}/sqlite/definitions.cmake)
add_definitions(${SQLITE_FLAGS})
target_compile_definitions(sqlite PRIVATE ${SQLITE_FLAGS})

set(module sqlite)
set(MODULE SQLITE)
configure_file(${PROJECT_SOURCE_DIR}/mem/mem.h.in mem_sqlite.h @ONLY)
configure_file(src/parse.y parse.y COPYONLY)
configure_file(tool/lempar.c lempar.c COPYONLY)
configure_file(tool/addopcodes.tcl addopcodes.tcl COPYONLY)
configure_file(tool/mkopcodec.tcl mkopcodec.tcl COPYONLY)
configure_file(tool/mkopcodeh.tcl mkopcodeh.tcl COPYONLY)

add_executable(mkkeywordhash tool/mkkeywordhash.c)
target_compile_definitions(mkkeywordhash PRIVATE ${SQLITE_FLAGS})
add_custom_command(
  OUTPUT keywordhash.h
  DEPENDS mkkeywordhash
  COMMAND mkkeywordhash > keywordhash.h
)

find_program(tclsh NAMES tclsh8.6 tclsh8.5 tclsh)
add_executable(lemon tool/lemon.c)
add_custom_command(
  OUTPUT parse.c parse.h
  DEPENDS lemon lempar.c parse.y
  COMMAND lemon ${SQLITE_FLAGS} parse.y
  COMMAND ${CMAKE_COMMAND} -E copy parse.h parse.h.temp
  COMMAND ${tclsh} addopcodes.tcl parse.h.temp > parse.h
)

add_custom_command(
  OUTPUT opcodes.c opcodes.h
  DEPENDS parse.h vdbe.c
  COMMAND cat parse.h ${CMAKE_CURRENT_SOURCE_DIR}/vdbe.c | ${tclsh} mkopcodeh.tcl > opcodes.h
  COMMAND sort -n -b -k 3 opcodes.h | ${tclsh} mkopcodec.tcl opcodes.h > opcodes.c
)
add_custom_command(
  OUTPUT serialget.c
  DEPENDS parse.c vdbeaux.c
  COMMAND sed -n "/START_INLINE_SERIALGET/,/END_INLINE_SERIALGET/p" ${CMAKE_CURRENT_SOURCE_DIR}/vdbeaux.c > serialget.c
)
add_custom_command(
  OUTPUT memcompare.c
  DEPENDS parse.c vdbeaux.c serialget.c
  COMMAND ${CMAKE_COMMAND} -E echo '\#include <serialget.c>' > memcompare.c
  COMMAND sed -n "/START_INLINE_MEMCOMPARE/,/END_INLINE_MEMCOMPARE/p" ${CMAKE_CURRENT_SOURCE_DIR}/vdbeaux.c >> memcompare.c
)
add_custom_command(
  OUTPUT vdbecompare.c
  DEPENDS parse.c memcompare.c
  COMMAND echo '\#include <memcompare.c>' > vdbecompare.c
  COMMAND sed -n "/START_INLINE_VDBECOMPARE/,/END_INLINE_VDBECOMPARE/p" ${CMAKE_CURRENT_SOURCE_DIR}/vdbeaux.c >> vdbecompare.c
)

include_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_BINARY_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/ext/comdb2
  ${CMAKE_CURRENT_SOURCE_DIR}/ext/misc
  ${CMAKE_CURRENT_SOURCE_DIR}/ext/expert
  ${PROJECT_SOURCE_DIR}
  ${PROJECT_SOURCE_DIR}/util
  ${PROJECT_SOURCE_DIR}/bbinc
  ${PROJECT_SOURCE_DIR}/bdb
  ${PROJECT_SOURCE_DIR}/cdb2api
  ${PROJECT_SOURCE_DIR}/csc2
  ${PROJECT_SOURCE_DIR}/datetime
  ${PROJECT_SOURCE_DIR}/db
  ${PROJECT_BINARY_DIR}/db
  ${PROJECT_SOURCE_DIR}/dfp/decNumber
  ${PROJECT_SOURCE_DIR}/dfp/dfpal
  ${PROJECT_SOURCE_DIR}/dlmalloc
  ${PROJECT_SOURCE_DIR}/lua
  ${PROJECT_SOURCE_DIR}/mem
  ${PROJECT_BINARY_DIR}/mem
  ${PROJECT_SOURCE_DIR}/net
  ${PROJECT_BINARY_DIR}/protobuf
  ${PROJECT_SOURCE_DIR}/schemachange
  ${PROJECT_SOURCE_DIR}/berkdb
  ${OPENSSL_INCLUDE_DIR}
  ${PROTOBUF_C_INCLUDE_DIR}
)
add_dependencies(sqlite mem protobuf)
